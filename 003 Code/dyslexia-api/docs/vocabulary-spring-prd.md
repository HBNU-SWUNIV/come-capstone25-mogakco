# Spring PRD: 어휘 분석 콜백 수신 및 RDB 저장(요구사항)

## 1. 목적/배경
- FastAPI(LLM)에서 PDF → 블록(TEXT) 변환 중, 각 블록이 생성될 때마다 어휘 분석 결과를 실시간으로 Spring에 전송한다.
- Spring은 수신 데이터를 RDB(`public.vocabulary_analysis`)에 멱등 저장하고, 이후 조회/가공/분석에 활용한다.
- 작업 전체 완료 시, 요약 콜백도 수용해 집계 및 운영 로그를 남긴다.

## 2. 범위
- 블록 단위 콜백 API, 완료 콜백 API, 유효성 검증, 보안, 멱등/업서트, 관찰성(로그/메트릭), 성능/신뢰성, 구성/배포, 테스트/수용 기준.

## 3. 용어/정의
- jobId: 비동기 상관키(멱등/추적)
- blockId: 문장 단위 블록 식별자(문서 내 유일)
- textbookId: 문서/교재 ID
- vocabularyItems: 블록의 어휘 분석 항목 배열(최소 1, 최대 5)

## 4. 시스템 컨텍스트
- FastAPI → Spring: 내부망 또는 사설 네트워크 통신 + `X-Callback-Token`으로 HMAC 수준 보호(간단 토큰)
- Spring → DB(PostgreSQL): `public.vocabulary_analysis`에 upsert 저장

## 5. API 요구사항
### 5.1 블록 단위 콜백(권장)
- Path: `POST /api/v1/ai/vocabulary/block`
- Headers
    - `X-Callback-Token: <token>` (서버 설정값과 일치해야 함)
    - (선택) `X-Request-Id`, `X-Trace-Id`
- Content-Type: `application/json`
- Body(JSON, snake_case/camelCase 혼용 허용)
    - 필수: `job_id|jobId`: string
    - 필수: `textbook_id|textbookId`: number
    - 필수: `block_id|blockId`: string
    - 선택: `page_number|pageNumber`: number
    - 선택: `original_sentence|originalSentence`: string
    - 선택: `created_at|createdAt`: ISO-8601
    - 필수: `vocabulary_items|vocabularyItems`: VocabularyItem[1..5]

VocabularyItem 스키마
- 필수: `word` (string, not blank)
- 필수: `start_index|startIndex` (int, >=0)
- 필수: `end_index|endIndex` (int, >start)
- 선택: `definition` (<=255)
- 선택: `simplified_definition|simplifiedDefinition` (<=255)
- 선택: `examples` (string | string[])
- 선택: `difficulty_level|difficultyLevel`
- 선택: `reason` (<=255)
- 선택: `grade_level|gradeLevel` (int)

응답(성공)
- 200 `{ "success": true, "jobId": "abc-123", "blockId": "b-12", "saved": 3 }`

에러(예시)
- 400 `{ "success": false, "error_code": "MISSING_JOB_ID", "message": "'job_id' is required" }`
- 401 `{ "success": false, "error_code": "UNAUTHORIZED", "message": "invalid token" }`
- 422 `{ "success": false, "error_code": "INVALID_ITEMS_COUNT", "message": "vocabulary_items must be 1..5" }`

서버 처리 규칙
- 유효성: items 길이 1..5 보장(>5면 상위 5개만 저장). 인덱스(end>start) 보정 시도(문장 내 첫 등장 기준). 긴 텍스트(definition 등) 255자로 절단.
- examples: 배열이면 `","` join 또는 JSON 문자열로 저장(택1, text 컬럼)
- 저장: `public.vocabulary_analysis` upsert (아래 6장 참조)

### 5.2 작업 완료 콜백(선택)
- Path: `POST /api/v1/ai/vocabulary/complete`
- Headers: `X-Callback-Token`
- Body(JSON)
    - `payload_version` (number), `result_type` ("VOCABULARY")
    - `job_id|jobId`, `textbook_id|textbookId`, `pdf_name|pdfName`
    - `s3_summary_url` (권장), `s3_blocks_prefix` (선택)
    - `stats`: { blocks, items, by_difficulty }
    - `created_at|createdAt`
- 응답: 200 `{ "success": true }`
- 처리: 감사/운영 로그 남기고 ACK (요약 저장은 선택)

### 5.3 호환 모드(옵션)
- 속성 `external.callback.acceptOnComplete=true`일 때, `/complete` 엔드포인트가 `vocabulary_items` 존재 시 블록 payload로 판단하고 DB upsert 수행. 운영 안정 후 비활성 권장.

## 6. DB 매핑(제공 스키마 준수)
- 테이블: `public.vocabulary_analysis`
```sql
create table public.vocabulary_analysis (
  id bigint generated by default as identity primary key,
  block_id varchar(255),
  created_at timestamp(6),
  definition varchar(255),
  difficulty_level varchar(255),
  end_index integer,
  examples text,
  grade_level integer,
  page_number integer,
  phoneme_analysis_json text,
  reason varchar(255),
  simplified_definition varchar(255),
  start_index integer,
  textbook_id bigint,
  word varchar(255)
);
```
- Unique Index(권장)
```sql
create unique index if not exists uq_vocab_item
  on public.vocabulary_analysis(textbook_id, block_id, word, start_index, end_index);
```
- Upsert 예시
```sql
insert into public.vocabulary_analysis (
  textbook_id, page_number, block_id,
  word, start_index, end_index,
  definition, simplified_definition, reason,
  examples, difficulty_level, grade_level,
  phoneme_analysis_json, created_at
) values (
  :textbook_id, :page_number, :block_id,
  :word, :start_index, :end_index,
  left(:definition,255), left(:simplified_definition,255), left(:reason,255),
  :examples_text, :difficulty_level, :grade_level,
  :phoneme_analysis_json, coalesce(:created_at, now())
) on conflict (textbook_id, block_id, word, start_index, end_index)
do update set
  definition = excluded.definition,
  simplified_definition = excluded.simplified_definition,
  reason = excluded.reason,
  examples = excluded.examples,
  difficulty_level = excluded.difficulty_level,
  grade_level = excluded.grade_level,
  phoneme_analysis_json = excluded.phoneme_analysis_json,
  created_at = coalesce(public.vocabulary_analysis.created_at, excluded.created_at);
```

## 7. 보안/권한
- `X-Callback-Token` 필수. 불일치/누락 → 401.
- (선택) 내부망 제한 또는 IP allowlist.

## 8. 멱등/신뢰성
- 멱등: Unique Index + upsert.
- 재시도: 클라이언트는 네트워크 오류/5xx에 한해 지수 백오프. 4xx는 재시도 금지(429 제외).

## 9. 관찰성(로그/메트릭)
- 로그: 수신 요약(jobId, blockId, items, status), 4xx/5xx 사유, upsert 소요시간.
- 메트릭: 요청 수/성공/실패/지연 분포, DB upsert 지표.

## 10. 성능/용량
- 목표: 100 req/s 기준 안정 동작(배치 upsert 시 더 높게 가능). 요청 바디 1–50KB 예상.

## 11. 구성(예시, application.yml)
```yaml
external:
  callback:
    token: ${EXTERNAL_CALLBACK_TOKEN:}
    accept-on-complete: false    # true 시 /complete에서 블록 페이로드도 수용(호환 모드)
  vocab:
    block-path: /api/v1/ai/vocabulary/block
```

## 12. 구현 스케치
- DTO
    - VocabularyItemDto(word, startIndex, endIndex, definition?, simplifiedDefinition?, examples?, difficultyLevel?, reason?, gradeLevel?)
    - VocabularyBlockRequestDto(jobId, textbookId, blockId, pageNumber?, originalSentence?, createdAt?, vocabularyItems[])
    - VocabularyCompleteRequestDto(payloadVersion, resultType, jobId, textbookId, pdfName, s3SummaryUrl?, s3BlocksPrefix?, stats?, createdAt?)
- Controller
    - POST /api/v1/ai/vocabulary/block → service.saveBlock(dto)
    - POST /api/v1/ai/vocabulary/complete → (acceptOnComplete && dto.hasVocabularyItems()) 저장; else 요약 처리
- Service
    - validate(dto) → examples 문자열화 → upsert repository
    - items 길이 clip(1..5), 긴 텍스트 255자 절단, 인덱스 보정 시도
- Repository
    - native upsert SQL 또는 JPA @Query

## 13. 마이그레이션/롤아웃 계획
1) Unique Index 적용, 블록 엔드포인트 배포
2) FastAPI와 통신 테스트(토큰/엔드포인트 검증)
3) 관찰성 지표 대시보드 구성 후 트래픽 확대
4) 필요 시 호환 모드(/complete 수용) → 안정화 후 비활성 권장

## 14. 수용 기준(AC)
- AC-1: 올바른 토큰과 페이로드로 /block 호출 시 200과 함께 DB에 행이 upsert 된다.
- AC-2: 같은 payload 재전송 시 중복 삽입 없이 갱신(upsert)된다.
- AC-3: vocabulary_items가 6개 이상이어도 상위 5개만 저장된다.
- AC-4: 잘못된 인덱스(end<=start)여도 가능한 범위 내 보정되어 저장되거나 422가 반환된다(정책 선택).
- AC-5: /complete 콜백 수신 시 200, stats 로그가 남는다.
- AC-6: 잘못된 토큰은 401로 거부되고 저장되지 않는다.

## 15. 테스트 계획
- 단위: DTO 유효성, examples 변환, 길이 절단, 인덱스 보정
- 통합: 200/400/401/422/5xx, 멱등, 대량 요청 부하, 토큰 미스매치
- E2E: FastAPI → Spring → DB 저장까지 검증(샘플 cURL 포함)

## 16. 샘플 cURL
블록 콜백
```bash
curl -X POST "http://localhost:8084/api/v1/ai/vocabulary/block" \
  -H "X-Callback-Token: $TOKEN" -H "Content-Type: application/json" \
  -d '{
    "job_id": "abc-123",
    "textbook_id": 7,
    "page_number": 1,
    "block_id": "b-12",
    "original_sentence": "전자영수증을 확인했어요.",
    "vocabulary_items": [
      { "word": "영수증", "start_index": 2, "end_index": 5, "definition": "..." }
    ],
    "created_at": "2025-01-15T12:35:12Z"
  }'
```
완료 콜백
```bash
curl -X POST "http://localhost:8084/api/v1/ai/vocabulary/complete" \
  -H "X-Callback-Token: $TOKEN" -H "Content-Type: application/json" \
  -d '{
    "payload_version": 1,
    "result_type": "VOCABULARY",
    "job_id": "abc-123",
    "textbook_id": 7,
    "pdf_name": "vocabulary.json",
    "s3_summary_url": "s3://bucket/jobs/abc-123/vocabulary/summary.json",
    "stats": { "blocks": 40, "items": 128 },
    "created_at": "2025-01-15T12:40:00Z"
  }'
```
